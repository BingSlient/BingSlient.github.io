<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>在 Ubuntu18.04 安装 LEMP，构建本地网站 | BingSlient's Blog</title><meta name="description" content="在 Ubuntu18.04 安装 LEMP，构建本地网站"><meta name="keywords" content="LEMP,LEMP 加固"><meta name="author" content="BingSlient"><meta name="copyright" content="BingSlient"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="https://bingslient.github.io/2019/08/07/本地 web 服务器搭建之LEMP/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="在 Ubuntu18.04 安装 LEMP，构建本地网站"><meta name="twitter:description" content="在 Ubuntu18.04 安装 LEMP，构建本地网站"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/BingSlient/cdn/cover/lemp.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="在 Ubuntu18.04 安装 LEMP，构建本地网站"><meta property="og:url" content="https://bingslient.github.io/2019/08/07/本地 web 服务器搭建之LEMP/"><meta property="og:site_name" content="BingSlient's Blog"><meta property="og:description" content="在 Ubuntu18.04 安装 LEMP，构建本地网站"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/BingSlient/cdn/cover/lemp.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-背景"><span class="toc-text">0x00  背景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-目的"><span class="toc-text">1. 目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-LEMP-栈简介"><span class="toc-text">2. LEMP 栈简介</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-实现"><span class="toc-text">0x01 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-环境搭建过程"><span class="toc-text">1. 环境搭建过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-安装-Linux-系统"><span class="toc-text">1.1 安装 Linux 系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-安装-Nginx"><span class="toc-text">1.2 安装 Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-安装-Php-fpm"><span class="toc-text">1.3 安装 Php-fpm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-安装-Mysql"><span class="toc-text">1.4 安装 Mysql</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-配置自己的网站"><span class="toc-text">2. 配置自己的网站</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-域名映射"><span class="toc-text">2.1 域名映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-配置-Nginx"><span class="toc-text">2.2 配置 Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-创建网站主页"><span class="toc-text">2.3 创建网站主页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-问题"><span class="toc-text">2.4 问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-本地服务器加固"><span class="toc-text">3.本地服务器加固</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-加固-Linux-系统"><span class="toc-text">3.1 加固 Linux 系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-加固-Nginx"><span class="toc-text">3.2 加固 Nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-加固-mysql"><span class="toc-text">3.3 加固 mysql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-加固-PHP"><span class="toc-text">3.4 加固 PHP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-参考资料"><span class="toc-text">0x02 参考资料</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/BingSlient/cdn/cover/lemp.jpeg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">BingSlient's Blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="https://cdn.jsdelivr.net/gh/BingSlient/cdn/photo/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description"></div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title"><div class="posttitle">在 Ubuntu18.04 安装 LEMP，构建本地网站</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-08-07<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-08-07</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/web-安全基础/">web 安全基础</a></span></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="0x00-背景"><a href="#0x00-背景" class="headerlink" title="0x00  背景"></a>0x00  背景</h1><h2 id="1-目的"><a href="#1-目的" class="headerlink" title="1. 目的"></a>1. 目的</h2><p>基于 LEMP 栈 搭建本地 web 服务器，实现一个能在本地网络中访问的网页，网页中实现对数据库的简单操作。</p>
<p><strong>学习目标：</strong></p>
<ul>
<li>理解 web 服务器的运行，学会手动搭建一个 web 服务器</li>
<li>学习简单的 HTML 和 PHP 知识，并编写网站前端和服务器端的代码</li>
<li>学习 MySQL 数据库的基本知识，完成数据库的基本操作，实现 PHP 和 MySQL 的连接</li>
<li>学习如何加固 LEMP 栈</li>
</ul>
<h2 id="2-LEMP-栈简介"><a href="#2-LEMP-栈简介" class="headerlink" title="2. LEMP 栈简介"></a>2. LEMP 栈简介</h2><p>LEMP 指代 Linux、Nginx、MySQL、PHP，是一个实现 web 服务器的栈，之所以简写为 LEMP 而不是 LNMP，因为Nginx 的读音同 Engine X，因此简写选的是 E 而不是 N，此外 LEMP 是实际可拼读的英文，而 LNMP 只能逐个字母发音（当然也有 LNMP 的简写，但个人比较支持 LEMP）。常见的搭建 web 服务器的组合还有 LAMP，它是 LEMP 的前辈， LAMP 中用的 web 服务器软件 为 Apache。</p>
<h1 id="0x01-实现"><a href="#0x01-实现" class="headerlink" title="0x01 实现"></a>0x01 实现</h1><h2 id="1-环境搭建过程"><a href="#1-环境搭建过程" class="headerlink" title="1. 环境搭建过程"></a>1. 环境搭建过程</h2><p><strong>目标环境</strong></p>
<p>linux+nginx+php- fpm+mysql</p>
<h3 id="1-1-安装-Linux-系统"><a href="#1-1-安装-Linux-系统" class="headerlink" title="1.1 安装 Linux 系统"></a>1.1 安装 Linux 系统</h3><p>Linux 系统使用 Ubuntu-18.04 版本，使用 VMware Workstation 安装其镜像，Ubuntu 镜像在其官网上下载。</p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564387874274.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp; sudo apt-get upgrade</span><br></pre></td></tr></table></figure>

<h3 id="1-2-安装-Nginx"><a href="#1-2-安装-Nginx" class="headerlink" title="1.2 安装 Nginx"></a>1.2 安装 Nginx</h3><p>在 Ubuntu 中安装 Nginx，只需要在终端输入以下命令即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nginx</span><br></pre></td></tr></table></figure>

<p>在浏览器中浏览 nginx 默认网页，http://主机地址，说明安装成功</p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564392035766.png" alt></p>
<h3 id="1-3-安装-Php-fpm"><a href="#1-3-安装-Php-fpm" class="headerlink" title="1.3 安装 Php-fpm"></a>1.3 安装 Php-fpm</h3><p>在终端输入以下命令即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get intall php-fpm</span><br></pre></td></tr></table></figure>

<p>查看服务是否运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status php7.2-fpm.service</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564392367696.png" alt></p>
<h3 id="1-4-安装-Mysql"><a href="#1-4-安装-Mysql" class="headerlink" title="1.4 安装 Mysql"></a>1.4 安装 Mysql</h3><p>在终端输入以下命令安装 mysql 和 php 的 mysql 支持：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mysql-server mysql-client php-mysql</span><br></pre></td></tr></table></figure>

<p>安装完成后，检查 mysql 服务器是否运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl mysql.service</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564659362935.png" alt></p>
<h2 id="2-配置自己的网站"><a href="#2-配置自己的网站" class="headerlink" title="2. 配置自己的网站"></a>2. 配置自己的网站</h2><p><strong>目标</strong></p>
<p>搭建本地网站 <a href="http://www.jaylen.com，配置" target="_blank" rel="noopener">www.jaylen.com，配置</a> Nginx 使其支持 php，本地网站显示一张图片，图片下方有个评论界面，可以输入评论，显示到网页中，评论会存到 mysql 数据库中。</p>
<h3 id="2-1-域名映射"><a href="#2-1-域名映射" class="headerlink" title="2.1 域名映射"></a>2.1 域名映射</h3><p>要在本地网络中，通过浏览器访问到 <a href="http://www.jaylen.com，需要修改主机的" target="_blank" rel="noopener">www.jaylen.com，需要修改主机的</a> hosts 文件，在 <code>/etc/hsots</code> 添加一行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">your-ip-add www.jaylen.com</span><br></pre></td></tr></table></figure>

<p>这样就不需要 DNS 服务器解析该域名了（域名并没有注册！！！，DNS 服务器是没有记录的）。</p>
<h3 id="2-2-配置-Nginx"><a href="#2-2-配置-Nginx" class="headerlink" title="2.2 配置 Nginx"></a>2.2 配置 Nginx</h3><p>首先需要配置 Nginx，使其支持 php，在 <code>/etc/nginx/conf.d</code> 目录下添加自己网站服务器的配置，<code>jaylen.com.conf</code> ，内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>  server configuration</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen [::]:80;</span><br><span class="line">    server_name jaylen.com;</span><br><span class="line">    root /var/www/jaylen.com; # 网站在主机的根目录</span><br><span class="line"></span><br><span class="line">    # Add index.php to the list if you are using PHP</span><br><span class="line">    index index.html index.htm index.nginx-debian.html index.php;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        # First attempt to serve request as file, then</span><br><span class="line">        # as directory, then fall back to displaying a 404.</span><br><span class="line">        try_files $uri $uri/ =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # pass PHP scripts to FastCGI server</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        include snippets/fastcgi-php.conf;</span><br><span class="line">    </span><br><span class="line">        # With php-fpm (or other unix sockets):</span><br><span class="line">        fastcgi_pass unix:/run/php/php7.2-fpm.sock;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试配置是否成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br></pre></td></tr></table></figure>

<p>成功的话，出现如下提示信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br></pre></td></tr></table></figure>

<p>重新加载配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<h3 id="2-3-创建网站主页"><a href="#2-3-创建网站主页" class="headerlink" title="2.3 创建网站主页"></a>2.3 创建网站主页</h3><p>首先为网站创建一个根目录 <code>/var/www/jaylen.com</code> ，用于存储网站内容，该目录和 Nginx 配置文件中的 <code>root</code> 指令的内容一致。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /var/www/jaylen.com</span><br></pre></td></tr></table></figure>

<p>写个简单的 html 页面和 php进行测试，<code>index.html</code> ， </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">                 jaylen's homepage</span><br><span class="line">             <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Welcome to Jaylen's Homepage<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">p</span>&gt;</span>Website is under construction, wait...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">bdoy</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>index.php</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">     &lt;body&gt;</span><br><span class="line">         &lt;head&gt;</span><br><span class="line">             &lt;title&gt;</span><br><span class="line">                 jaylen&apos;s homepage</span><br><span class="line">             &lt;/title&gt;</span><br><span class="line">         &lt;/head&gt;</span><br><span class="line">         &lt;h1&gt;Welcome to Jaylen&apos;s Homepage&lt;/h1&gt;</span><br><span class="line">         &lt;p&gt;Website is under construction, wait...&lt;/p&gt;</span><br><span class="line">         &lt;?php</span><br><span class="line">             echo phpinfo();</span><br><span class="line">         ?&gt;</span><br><span class="line">     &lt;/bdoy&gt;</span><br><span class="line"> &lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>通过浏览器浏览网站 <a href="http://www.jaylen.com" target="_blank" rel="noopener">www.jaylen.com</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564820064946.png" alt></p>
<p>浏览 <a href="http://www.jaylen.com/index.php" target="_blank" rel="noopener">www.jaylen.com/index.php</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564820032466.png" alt></p>
<p>浏览 <a href="http://www.jaylen.com/index.php" target="_blank" rel="noopener">www.jaylen.com/index.php</a></p>
<p>测试完成，没有问题。</p>
<p>进一步完善网页内容，使其显示一张图片，图片下方带有评论输入框，可以提交评论，提交的评论存到主机的 mysql 数据库中，而后显示在评论区，最后完成的大致如下图，简陋的不行。</p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564840770425.png" alt><br>在 mysql 中创建一个新用户，并授权 INSERT、SELECT 权限，评论内容需要存到数据库，并读取数据库内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt;</span><br><span class="line">CREATE USER &apos;user101&apos;@&apos;localhost&apos;</span><br><span class="line">  IDENTIFIED BY &apos;webdev101@Webdev102&apos;;</span><br><span class="line">GRANT INSERT,SELECT</span><br><span class="line">  ON *.*</span><br><span class="line">  TO &apos;user101&apos;@&apos;localhost&apos;</span><br><span class="line">  WITH GRANT OPTION;</span><br></pre></td></tr></table></figure>

<p>刷新授权表，退出，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; FLUSH PRIVILEGE;</span><br><span class="line">mysql&gt; quit;</span><br></pre></td></tr></table></figure>

<p>以新创建的用户重新登陆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u user101 -p</span><br></pre></td></tr></table></figure>

<p>创建一个数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database webdb101</span><br></pre></td></tr></table></figure>

<p>切换到该数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use webdb101</span><br></pre></td></tr></table></figure>

<p>创建一个表格，用于存放评论内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE comments (</span><br><span class="line">id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">comment VARCHAR(200) NOT NULL</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>插入一条数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO comments(comment) VALUES (&apos;test&apos;);</span><br></pre></td></tr></table></figure>

<p>最终的 <code>index.php</code> 文件内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML&gt;  </span><br><span class="line"> &lt;html&gt;</span><br><span class="line"> &lt;head&gt;</span><br><span class="line"> &lt;style&gt;</span><br><span class="line"> .error &#123;color: #FF0000;&#125;</span><br><span class="line"> img &#123;</span><br><span class="line">     width: 30%;</span><br><span class="line">     height: auto;</span><br><span class="line"> &#125;</span><br><span class="line"> td &#123;</span><br><span class="line">     border: 1px solid black;</span><br><span class="line"> &#125;</span><br><span class="line"> &lt;/style&gt;</span><br><span class="line"> &lt;/head&gt;</span><br><span class="line"> &lt;body&gt;  </span><br><span class="line"> </span><br><span class="line"> &lt;?php</span><br><span class="line"> // define variables and set to empty values</span><br><span class="line"> </span><br><span class="line"> include(&apos;connect-mysql.php&apos;);</span><br><span class="line"> </span><br><span class="line"> $comment = &quot;&quot;; </span><br><span class="line"> $commentErr = &quot;&quot;; </span><br><span class="line"> </span><br><span class="line"> if ($_SERVER[&quot;REQUEST_METHOD&quot;] == &quot;POST&quot;) &#123;</span><br><span class="line">   if (empty($_POST[&quot;comment&quot;])) &#123;</span><br><span class="line">     $commentErr = &quot;You must write someting...&quot;;</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     $comment = test_input($_POST[&quot;comment&quot;]);</span><br><span class="line">     $sql = &quot;INSERT INTO comments (comment) VALUES (&apos;&quot;.$comment.&quot;&apos;)&quot;;</span><br><span class="line">     if (mysqli_query($dbcon, $sql)) &#123;</span><br><span class="line">         $commentErr = &quot;Submit comment successfully!&quot;;</span><br><span class="line">     &#125;   </span><br><span class="line">     else &#123;</span><br><span class="line">         $commentErr = &quot;Error:&quot; . $sql . &quot;&lt;br&gt;&quot; . mysqli_error($dbcon);</span><br><span class="line">     &#125;   </span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> function test_input($data) &#123;</span><br><span class="line">   $data = trim($data);</span><br><span class="line">   $data = stripslashes($data);</span><br><span class="line">   $data = htmlspecialchars($data);</span><br><span class="line">   return $data;</span><br><span class="line"> &#125;</span><br><span class="line"> ?&gt;</span><br><span class="line"> </span><br><span class="line"> &lt;h1&gt;Jaylen&apos;s HomePage&lt;/h1&gt;</span><br><span class="line"> &lt;img src=&apos;image/homepage.jpeg&apos; alt=&apos;homepage icon&apos;&gt; </span><br><span class="line"> &lt;form method=&quot;post&quot; action=&quot;&lt;?php echo htmlspecialchars($_SERVER[&quot;PHP_SELF&quot;]);?&gt;&quot;&gt;  </span><br><span class="line">   &lt;hr&gt;</span><br><span class="line">   &lt;p&gt;Wirte your comment here!&lt;/p&gt;</span><br><span class="line">   &lt;textarea name=&quot;comment&quot; rows=&quot;5&quot; cols=&quot;80&quot;&gt;&lt;?php echo $comment;?&gt;&lt;/textarea&gt;</span><br><span class="line">   &lt;span class=&apos;error&apos;&gt;*&lt;?php echo $commentErr; ?&gt;&lt;/span&gt;</span><br><span class="line">   &lt;br&gt;&lt;/br&gt;</span><br><span class="line">   &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Submit&quot;&gt;  </span><br><span class="line">   &lt;hr&gt;</span><br><span class="line"> &lt;/form&gt;</span><br><span class="line"> &lt;?php</span><br><span class="line"> $sqlget = &quot;SELECT * FROM comments&quot;;</span><br><span class="line"> $sqldata = mysqli_query($dbcon, $sqlget) or die(&quot;Fail to connect to database!&quot; .  mysqli_error($dbcon));</span><br><span class="line"> </span><br><span class="line"> echo &quot;&lt;table&gt;&quot;;</span><br><span class="line"> echo &quot;&lt;tr&gt;&lt;th&gt;Comments&lt;/th&gt;&lt;/tr&gt;&quot;;</span><br><span class="line"> </span><br><span class="line"> while($row = mysqli_fetch_array($sqldata, MYSQLI_ASSOC)) &#123;</span><br><span class="line">     echo &quot;&lt;tr&gt;&lt;td&gt;&quot;;</span><br><span class="line">     echo $row[&apos;comment&apos;];</span><br><span class="line">     echo &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> echo &quot;&lt;/table&gt;&quot;;</span><br><span class="line"> ?&gt;</span><br><span class="line"> &lt;/body&gt;</span><br><span class="line"> &lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>连接数据库的操作，单独放到 <code>connec-mysql.php</code> 文件中。</p>
<p>在网页中测试下提交评论，</p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564841954745.png" alt></p>
<h3 id="2-4-问题"><a href="#2-4-问题" class="headerlink" title="2.4 问题"></a>2.4 问题</h3><p>记录搭建自己本地网络过程中遇到的问题。</p>
<ol>
<li><p>配置 Nginx 使其支持 php 时，访问 <a href="http://localhsot/index.php，出现" target="_blank" rel="noopener">http://localhsot/index.php，出现</a> <code>502 Bad Gateway</code> 错误，查看 Nginx 错误日志 <code>/var/log/nginx/error.log</code> ，找到错误记录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019/08/02 03:11:53 [crit] 4293#4293: *50 connect() to unix:/var/run/php/php7.0-fpm.sock failed (2: No such file or directory) while connecting to upstream, client: 192.168.47.129, server: _, request: &quot;GET /index.php HTTP/1.1&quot;, upstream: &quot;fastcgi://unix:/var/run/php/php7.0-fpm.sock:&quot;, host: &quot;192.168.47.129&quot;</span><br></pre></td></tr></table></figure>

<p>原因是找不到 <code>unix:/var/run/php/php7.0-fpm.sock</code>文件，而我安装的版本是 7.2 的，因此应该是配置错误了，在系统中查找 <code>php7.0-fpm.sock</code>  发现实际路径为 <code>/run/php/php7.0-fpm.sock</code> 修改 <code>/etc/nginx/sites-avalable/default</code> 文件如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> pass PHP scripts to FastCGI server</span></span><br><span class="line">   </span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">        include snippets/fastcgi-php.conf;</span><br><span class="line">   </span><br><span class="line">        # With php-fpm (or other unix sockets):</span><br><span class="line">        fastcgi_pass unix:/run/php/php7.2-fpm.sock;</span><br><span class="line">        # With php-cgi (or other tcp sockets):</span><br><span class="line">        #fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在  <code>index.php</code> 文件中对数据库进行插入操作时，提示错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Unknown column &apos;&apos; in &apos;field list&apos;</span><br></pre></td></tr></table></figure>

<p>原因时插入的数据是 <code>VARCHAR</code> 类型，需要额外添加双引号，我原来的 sql 语句如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"INSERT INTO comments (comment) VALUES ($comment)"</span>;</span><br></pre></td></tr></table></figure>

<p>这样实际导致 <code>$comment</code> 变量展开后是一个标识符，而不是字符串，需要在外面添加额外的双引号，具体处理如下，注意在单引号中 <code>$</code> 不会被识别成特殊字符，因此不会展开变量，而双引号中不能直接包含双引号，所以就成了下面的结果。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = <span class="string">"INSERT INTO comments (comment) VALUES ('"</span>.$comment.<span class="string">"')"</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="3-本地服务器加固"><a href="#3-本地服务器加固" class="headerlink" title="3.本地服务器加固"></a>3.本地服务器加固</h2><h3 id="3-1-加固-Linux-系统"><a href="#3-1-加固-Linux-系统" class="headerlink" title="3.1 加固 Linux 系统"></a>3.1 加固 Linux 系统</h3><p><strong>时刻保持系统和软件为最新版本</strong></p>
<p>在 Ubuntu 中检查系统需要更新的软件包，使用如下命令，<code>apt-get -s</code>  命令用于模拟后面命令的操作，但实际不会改变系统的状态，所以 <code>apt-get -s upgrade</code> 只会模拟软件更新的过程，你会看到被更新的软件的信息，但实际并没有更新到系统上  ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get -s upgrade</span><br></pre></td></tr></table></figure>

<p>然后根据需要更新你想要更新的软件。如果你想更新所有软件，使用如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get upgrade</span><br></pre></td></tr></table></figure>

<p><strong>加固远程登陆</strong></p>
<p>在使用和管理服务器时，往往我们需要远程登陆服务器，这就需要我们保证远程登陆过程的安全性。以下步骤一定程度提高了远程登陆的安全性。</p>
<ol>
<li>强制使用高强度用户密码（数字、字母、字符的组合且长度14位以上）</li>
<li>更改 SSH 默认的端口（22）为随机端口</li>
<li>禁止 root 身份的远程登陆</li>
<li>使用公钥认证机制进行远程登陆</li>
<li>使用 Linux 标准用户而不是 root 用户执行上述操作，并且该用户的权限可提升成 root 权限</li>
</ol>
<p>现以 Ubuntu 系统为例，完成上述操作：</p>
<p><strong>强制使用高强度用户密码</strong></p>
<p>要强制用户使用高强度密码，需要安装额外的模块 <code>libpam-cracklib</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libpam-cracklib</span><br></pre></td></tr></table></figure>

<p>在 Ubuntu 中，密码策略（规定密码的长度，字符等）定义在 <code>/etc/pam.d/common-password</code> 文件中，如果要规定，密码长度为 14，包含大小写字符数字和字符，在文件中，在 <code>pam_unix.so</code>的前一行，添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password required pam_cracklib.so try_first_pass retry=3 minlen=14 lcredit=-1 ucredit=-1 dcredit=-1 ocredit=-1 difok=2 reject_username</span><br></pre></td></tr></table></figure>

<p>上述配置的选项的描述如下，详情参考 <a href="http://www.linux-pam.org/Linux-PAM-html/sag-pam_cracklib.html" target="_blank" rel="noopener">libpam-cracklib 文档</a>：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>retry=N</td>
<td>设置密码时的，最大重试次数</td>
</tr>
<tr>
<td>minlen=N</td>
<td>新密码的最小长度</td>
</tr>
<tr>
<td>lcredit=N</td>
<td>最少小写字母数，小于0，正常计算 minlen，大于0，计算 minlen 额外加 1</td>
</tr>
<tr>
<td>ucredt=N</td>
<td>最少大写字母数，小于0，正常计算 minlen，大于0，计算 minlen 额外加 1</td>
</tr>
<tr>
<td>dcredit=N</td>
<td>最少数字的数，小于0，正常计算 minlen，大于0，计算 minlen 额外加 1</td>
</tr>
<tr>
<td>ocredit=N</td>
<td>最少其它字符数，小于0，正常计算 minlen，大于0，计算 minlen 额外加 1</td>
</tr>
<tr>
<td>difok=N</td>
<td>和旧密码不同的字符数</td>
</tr>
<tr>
<td>reject_username</td>
<td>禁止用户名作为密码</td>
</tr>
</tbody></table>
<p>==总之规定各种字符类型的个数，要使用负数，其绝对值表示该类型字符至少有多少个。==</p>
<p><strong>更改 SSH 默认的端口（22）为随机端口</strong></p>
<p><strong>禁止 root 身份的远程登陆</strong></p>
<p>修改 ssh-server 的配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>

<p>找到 <code># Port 22</code> 更改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Port 2019</span><br></pre></td></tr></table></figure>

<p>找到 <code>#PermitRootLogin</code>，更改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin no</span><br></pre></td></tr></table></figure>

<p>远程登陆则需要指定该端口执行登陆，而且无法使用 root 用户登陆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sss username@ip-addr -p 2019</span><br></pre></td></tr></table></figure>

<p><strong>使用公钥认证机制进行远程登陆</strong></p>
<p>SSH 登陆 提供<a href="https://www.linode.com/docs/security/authentication/use-public-key-authentication-with-ssh/" target="_blank" rel="noopener">公钥认证机制</a>的登陆，即不需要密码的登陆方式，但是需要客户端生成公钥和私钥，并将公钥发送给服务端，服务端将公钥添加到相应用户的配置文件中。</p>
<p>首先客户端需要生成，密钥对：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096</span><br></pre></td></tr></table></figure>

<p>使用默认文件名，一路 <strong>Enter</strong> 最后，生成的密钥对文件在  <code>~/.ssh/</code> 目录下，其中 <code>id_rsa</code> 为私钥，<code>id_rsa.pub</code> 为公钥。</p>
<p>接着使用将公钥文件上传到服务器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id username@ip-addr -p portnum</span><br></pre></td></tr></table></figure>

<p>该命令会把公钥文件的内容，写入到 <code>/home/username/ssh/authorized_keys</code> 文件中，所以也可以手动添加内容。如此一来就可以 <code>username</code> 的身份，不使用密码登陆服务器了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2019 username@ip-addr</span><br></pre></td></tr></table></figure>

<h3 id="3-2-加固-Nginx"><a href="#3-2-加固-Nginx" class="headerlink" title="3.2 加固 Nginx"></a>3.2 加固 Nginx</h3><p><strong>防止信息泄露</strong></p>
<p>Nginx 默认开启 Server Token（显示版本号），这样使得 Nginx 的版本号很容易被获取，如下图为连接域名不存在资源时的返回页面，可以看到 Nginx 的版本号</p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564802848522.png" alt><br>在 <code>/etc/nginx/nginx.conf</code> 中 http 块中添加（去掉注释即可）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_tokens off</span><br></pre></td></tr></table></figure>

<p>关闭后，访问域名下不存在的资源，返回页面中没有了 Nginx 的版本号 信息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/BingSlient/WebSecurityLearning/WebSecurityBasics/images/1564815315221.png" alt></p>
<p><strong>增加访问控制策略</strong></p>
<p>Nginx 可以使用 <code>allow</code> 和 <code>deny</code> 指令在配置文件中允许或禁止特定 IP 的访问， 编辑 Niginx 配置文件 <code>/etc/nginx/conf.d/jaylen.com.conf</code>，只允许 192.168.47.129 192.168.47.130 访问 网站 <a href="http://www.jaylen.com" target="_blank" rel="noopener">www.jaylen.com</a> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#  server configuration</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80; </span><br><span class="line">    listen [::]:80;</span><br><span class="line"></span><br><span class="line">    # IPs access control</span><br><span class="line">    allow 192.168.47.129;</span><br><span class="line">    allow 192.168.47.130;</span><br><span class="line">    deny all;</span><br><span class="line">        </span><br><span class="line">    root /var/www/jaylen.com;</span><br></pre></td></tr></table></figure>

<p><strong>使用 TLS 加固 Nginx</strong></p>
<p><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener">TLS</a> 可以加密客户端和服务端通信的数据，降低信息泄露的风险。对于本地网站可以使用 <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security" target="_blank" rel="noopener">SSL 自签 证书</a> 实现 HTTPS 连接。当然在公网中使用的网站，通常会使用 CA 认证的证书，要免费使用 SSL 证书，可参考：</p>
<p><a href="https://www.howtoforge.com/tutorial/nginx-with-letsencrypt-ciphersuite/#step-install-letsencrypt-and-generate-certificates" target="_blank" rel="noopener">How to Install Nginx with Let’s encrypt and get A+ from SSLLabs Test</a></p>
<p>要在 Nginx 配置自签证书，首先在配置目录下建一个文件夹，进到文件夹中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /etc/nginx/ssl/</span><br><span class="line"><span class="built_in">cd</span> /etc/nginx/ssl</span><br></pre></td></tr></table></figure>

<p>生成密钥：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo openssl genrsa -aes256 -out nginx.key 1024</span><br></pre></td></tr></table></figure>

<p>接着生成 <a href="https://en.wikipedia.org/wiki/Certificate_signing_request" target="_blank" rel="noopener">CSR</a>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo openssl req -new -key nginx.key -out nginx.csr</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Enter pass phrase for nginx.key:</span><br><span class="line">Can&apos;t load /home/jaylen/.rnd into RNG</span><br><span class="line">140067713049024:error:2406F079:random number generator:RAND_load_file:Cannot open file:../crypto/rand/randfile.c:88:Filename=/home/jaylen/.rnd</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &apos;.&apos;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:CN </span><br><span class="line">State or Province Name (full name) [Some-State]:Guangdong</span><br><span class="line">Locality Name (eg, city) []:Guangzhou</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:IT</span><br><span class="line">Organizational Unit Name (eg, section) []:IT</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:www.jaylen.com</span><br><span class="line">Email Address []:jaylen@gmail.com</span><br><span class="line"></span><br><span class="line">Please enter the following &apos;extra&apos; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:admin           </span><br><span class="line">An optional company name []:IT</span><br></pre></td></tr></table></figure>

<p>最后，签发证书：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo openssl x509 -req -days 365 -in nginx.csr -signkey nginx.key -out nginx.crt</span><br></pre></td></tr></table></figure>

<p>成功签发：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ignkey nginx.key -out nginx.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject=C = CN, ST = Guangdong, L = Guangzhou, O = IT, OU = IT, CN = www.jaylen.com, emailAddress = jaylen@gmail.com</span><br><span class="line">Getting Private key</span><br><span class="line">Enter pass phrase for nginx.key:</span><br></pre></td></tr></table></figure>

<p>接着在 <code>/etc/nginx/conf.d/jaylen.com.conf</code> 中修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    ssl_certificate /etc/nginx/ssl/nginx.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/ssl/nginx.key;</span><br><span class="line">    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span><br></pre></td></tr></table></figure>

<p>重新加载 Nginx 配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p>提示输入之前步骤设置的密码，输入即可。</p>
<p>其它 加固措施，可仔细阅读：</p>
<p><a href="https://www.cyberciti.biz/tips/linux-unix-bsd-nginx-webserver-security.html" target="_blank" rel="noopener">Top 25 Nginx Web Server Best Security Practices</a></p>
<p><a href="https://geekflare.com/nginx-webserver-security-hardening-guide/" target="_blank" rel="noopener">Nginx Web Server Security and Hardening Guide</a></p>
<h3 id="3-3-加固-mysql"><a href="#3-3-加固-mysql" class="headerlink" title="3.3 加固 mysql"></a>3.3 加固 mysql</h3><p>运行 <code>mysql_secure_installation</code> 工具（安装 mysql 后自带的 shell 脚本），进行 mysql 的安全检查，</p>
<p>根据提示，设置密码为最高级别，并为 root 用户设置密码，最后同意以下选项：</p>
<ul>
<li>Remove anonymous users? – 删除匿名用户</li>
<li>Disallow root login remotely? – 禁止远程使用 root 用户登陆</li>
<li>Remove test database and access to it? – 删除测试数据库和其访问权限</li>
<li>Reload privilege tables now? – 重载授权表</li>
</ul>
<h3 id="3-4-加固-PHP"><a href="#3-4-加固-PHP" class="headerlink" title="3.4 加固 PHP"></a>3.4 加固 PHP</h3><p><strong>修改 <code>php.ini</code> 文件</strong></p>
<p><strong>当文件不存在时停止 PHP 处理</strong></p>
<p>Nginx 对于 PHP 支持的配置文件中常常会使用如下形式的配置，该配置使得 PHP 解释器接受所有以 <code>.php</code>结尾的 URI，这样一来就会存在很大的风险，存在任意代码执行漏洞，具体解释见参考资料 [6]。</p>
<p>修改 <code>/etc/php/7.2/fpm/php.ini</code>文件（不同系统该文件位置略有不同），设置<code>cgi.fix_pathinfo=0</code>，可以禁止 PHP 解释器查找文件系统中不存在的文件，使用sed 命令完成文件内容的修改：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">'s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g'</span> /etc/php/7.2/fpm/php.ini</span><br></pre></td></tr></table></figure>

<p><strong>禁用危险的 PHP 函数</strong></p>
<p>在 <code>php.ini</code> 中添加：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable_functions =exec,eval,phpinfo,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source</span><br></pre></td></tr></table></figure>

<p><strong>限制文件上传功能</strong></p>
<p>如果网站不需要文件上传功能，应该禁用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_uploads=Off</span><br></pre></td></tr></table></figure>

<p>如果需要上传功能，则设置文件的大小，根据实际情况设置，如头像图片上传1M足矣。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file_uploads=On</span><br><span class="line">upload_max_filesize=1M</span><br></pre></td></tr></table></figure>

<p><strong>设置 POST 方法传输数据的大小</strong></p>
<p>POST 方法是当客户端需要向服务器发送数据时使用的，该方法可被用于对服务器进行 DoS 攻击等，所以需要将其能传输的数据大小设置成合理的数值，如果网站不需要上传文件等数据量大的操作，4KB也应该足够了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post_max_size=1K</span><br></pre></td></tr></table></figure>

<p><strong>防止 PHP 信息泄露</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expose_php = Off</span><br></pre></td></tr></table></figure>

<p><strong>限制 PHP 脚本的最长执行时间</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># set in seconds</span><br><span class="line">max_execution_time = 30 #最长执行时间 30 s</span><br><span class="line">max_input_time = 30		#脚本解析输入最长时间30s</span><br><span class="line">memory_limit = 40M 		#脚本最大使用内存40M</span><br></pre></td></tr></table></figure>

<p>这样可以有效防止大规模的 DOS 攻击。</p>
<p><strong>禁用未使用的 PHP 模块</strong></p>
<p>查看已安装的 PHP 模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -m</span><br></pre></td></tr></table></figure>

<p>根据实际情况，禁用不使用模块，注释掉 <code>php.ini</code>相应的配置行。</p>
<h1 id="0x02-参考资料"><a href="#0x02-参考资料" class="headerlink" title="0x02 参考资料"></a>0x02 参考资料</h1><p>[1] <a href="https://www.linode.com/docs/web-servers/lemp/how-to-install-a-lemp-server-on-ubuntu-18-04" target="_blank" rel="noopener">Install a LEMP Stack on Ubuntu 18.04</a></p>
<p>[2] <a href="https://www.linode.com/docs/web-servers/nginx/serve-php-php-fpm-and-nginx/" target="_blank" rel="noopener">Serve PHP with PHP-FPM and NGINX</a></p>
<p>[3] <a href="https://www.keycdn.com/support/nginx-vs-apache" target="_blank" rel="noopener">Nginx vs Apache</a></p>
<p>[4] <a href="https://www.keycdn.com/support/nginx-reverse-proxy" target="_blank" rel="noopener">Setting up an Nginx Reverse Proxy</a></p>
<p>[5] <a href="https://www.linode.com/docs/web-servers/nginx/nginx-installation-and-basic-setup/#configuration-recap" target="_blank" rel="noopener">Getting  Started with NGINX</a></p>
<p>[6] <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/?highlight=pitfalls#passing-uncontrolled-requests-to-php" target="_blank" rel="noopener">Passing Uncontrolled Requests to PHP</a></p>
<p>[7] <a href="https://blog.csdn.net/qq_15936309/article/details/51859761" target="_blank" rel="noopener">Unknown column &#39;&#39; in &#39;field list&#39;解决方案</a></p>
<p>[8] <a href="https://lemp.io/" target="_blank" rel="noopener">What’s a LEMP stack?</a></p>
<p>[9] <a href="https://www.rosehosting.com/blog/how-to-secure-your-lemp-stack/" target="_blank" rel="noopener">How to secure LEMP stack</a></p>
<p>[10] <a href="https://www.linode.com/docs/security/authentication/use-public-key-authentication-with-ssh/" target="_blank" rel="noopener">Use Public Key Authentication with SSH</a></p>
<p>[11] <a href="https://www.cyberciti.biz/tips/linux-unix-bsd-nginx-webserver-security.html" target="_blank" rel="noopener">Top 25 Nginx Web Server Best Security Practices</a></p>
<p>[12] <a href="https://geekflare.com/nginx-webserver-security-hardening-guide/" target="_blank" rel="noopener">Nginx Web Server Security and Hardening Guide</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">BingSlient</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://bingslient.github.io/2019/08/07/本地 web 服务器搭建之LEMP/">https://bingslient.github.io/2019/08/07/本地 web 服务器搭建之LEMP/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://bingslient.github.io">BingSlient's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/LEMP/">LEMP    </a><a class="post-meta__tags" href="/tags/LEMP-加固/">LEMP 加固    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/BingSlient/cdn/cover/lemp.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2019 By BingSlient</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="footer_custom_text">Photo by <a href="https://unsplash.com/@pawel_czerwinski">Paweł Czerwiński</a> on Unsplash.</div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="fa fa-moon-o nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script>$(function () {
  $('span.katex-display').wrap('<div class="katex-wrap"></div>')
})</script><script src="/js/nightshift.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zindex="-1" data-click="false"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script></body></html>